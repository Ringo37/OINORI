<!DOCTYPE html>
<html>
  <head>
    <title>Realtime Transcription & Visualizer</title>
    <style>
      /* å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š */
      body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        background-color: #1a1a1a; /* æš—ã„èƒŒæ™¯ */
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        font-family: sans-serif;
      }

      /* æ“ä½œãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå·¦ä¸Šã«é…ç½®ï¼‰ */
      .controls {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 8px;
      }

      button {
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
      }

      /* éŸ³ã«åå¿œã™ã‚‹çƒä½“ */
      #sphere {
        width: 150px;
        height: 150px;
        background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
        border-radius: 50%;
        box-shadow: 0 0 30px rgba(0, 210, 255, 0.6);
        transition: transform 0.05s ease-out; /* æ»‘ã‚‰ã‹ã«å‹•ã‹ã™ */
        will-change: transform;
      }

      /* å­—å¹•ã‚¨ãƒªã‚¢å…¨ä½“ */
      #transcription {
        position: absolute;
        bottom: 10%;
        width: 80%;
        text-align: center;
        font-size: 1.5rem; /* å°‘ã—å°ã•ãã—ã¦è¤‡æ•°è¡Œè¦‹ã‚„ã™ã */
        font-weight: bold;
        text-shadow: 2px 2px 4px #000000, 0 0 10px rgba(0, 0, 0, 0.8);
        pointer-events: none;
        line-height: 1.5;
        max-height: 40vh; /* è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’åºƒã’ã‚‹ */
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
      }

      /* å€‹åˆ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
      .message-row {
        margin: 5px 0;
        padding: 5px 15px;
        border-radius: 10px;
        animation: fadeIn 0.3s ease-in;
      }

      /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ï¼ˆç™½ï¼‰ */
      .user-message {
        color: #ffffff;
      }

      /* AIã®ç™ºè¨€ï¼ˆé»„è‰²ãƒ»å°‘ã—å¼·èª¿ï¼‰ */
      .ai-message {
        color: #ffeb3b; /* é®®ã‚„ã‹ãªé»„è‰² */
        font-size: 1.1em; /* å°‘ã—å¤§ãã */
      }

      /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆèµ¤ï¼‰ */
      .error-message {
        color: #ff5252;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <h1 style="color: white; font-size: 16px; margin: 0 0 10px 0">
        AI Conversation
      </h1>
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <div id="sphere"></div>

    <div id="transcription"></div>

    <script>
      let socket;
      let audioContext;
      let processor;
      let input;
      let globalStream;
      let analyser;
      let animationId;

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const transcriptionDiv = document.getElementById("transcription");
      const sphere = document.getElementById("sphere");

      startBtn.onclick = async () => {
        // WebSocketæ¥ç¶š
        socket = new WebSocket(
          "ws://" + window.location.host + "/ws/transcribe/"
        );

        socket.onopen = async () => {
          console.log("WebSocket Connected");
          startRecording();
        };

        socket.onmessage = (e) => {
          const data = JSON.parse(e.data);

          const div = document.createElement("div");
          div.classList.add("message-row");
          div.innerText = data.message;

          // --- ã“ã“ã§è‰²åˆ†ã‘ ---
          if (data.type === "ai") {
            div.classList.add("ai-message");
            // AIãŒå–‹ã£ãŸã¨ãã¯å­—å¹•ã«ã€ŒAI:ã€ã¨ä»˜ã‘ã¦ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ã‹ã‚‚ï¼ˆãŠå¥½ã¿ã§ï¼‰
            // div.innerText = "ğŸ¤– " + data.message;
          } else if (data.type === "error") {
            div.classList.add("error-message");
          } else {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆç™½ï¼‰
            div.classList.add("user-message");
          }

          transcriptionDiv.appendChild(div);

          // è¡¨ç¤ºæ•°ã‚’åˆ¶é™ï¼ˆå¤ã„ã‚‚ã®ã‚’æ¶ˆã™ï¼‰
          if (transcriptionDiv.childElementCount > 6) {
            transcriptionDiv.removeChild(transcriptionDiv.firstChild);
          }
        };
      };

      stopBtn.onclick = () => {
        stopRecording();
        if (socket) socket.close();
      };

      async function startRecording() {
        startBtn.disabled = true;
        stopBtn.disabled = false;
        transcriptionDiv.innerHTML = "";

        audioContext = new (window.AudioContext || window.webkitAudioContext)({
          sampleRate: 16000,
        });

        try {
          globalStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          input = audioContext.createMediaStreamSource(globalStream);

          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          input.connect(analyser);

          visualize();

          processor = audioContext.createScriptProcessor(4096, 1, 1);
          input.connect(processor);

          const muteNode = audioContext.createGain();
          muteNode.gain.value = 0;
          processor.connect(muteNode);
          muteNode.connect(audioContext.destination);

          processor.onaudioprocess = (e) => {
            const inputData = e.inputBuffer.getChannelData(0);
            if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(inputData.buffer);
            }
          };
        } catch (e) {
          console.error(e);
          alert("ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ");
        }
      }

      function visualize() {
        if (!analyser) return;

        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          sum += dataArray[i];
        }
        const average = sum / dataArray.length;

        const scale = 1 + average * 0.02;

        sphere.style.transform = `scale(${scale})`;

        animationId = requestAnimationFrame(visualize);
      }

      function stopRecording() {
        startBtn.disabled = false;
        stopBtn.disabled = true;

        if (globalStream)
          globalStream.getTracks().forEach((track) => track.stop());
        if (processor) processor.disconnect();
        if (analyser) analyser.disconnect();
        if (input) input.disconnect();
        if (audioContext) audioContext.close();
        if (animationId) cancelAnimationFrame(animationId);

        sphere.style.transform = "scale(1)";
      }
    </script>
  </body>
</html>
