<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AIé¢æ¥ç·´ç¿’ - Home</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      body {
        margin: 0;
        background-color: #1a1a1a;
        font-family: sans-serif;
        overflow: hidden;
        color: white;
      }

      /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
      .fade-out {
        opacity: 0;
        transition: opacity 0.5s ease-out;
        pointer-events: none;
      }
      .fade-in {
        opacity: 1;
        transition: opacity 0.5s ease-in;
      }

      /* é¢æ¥ç”»é¢ã®çƒä½“ */
      #sphere {
        width: 150px;
        height: 150px;
        background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
        border-radius: 50%;
        box-shadow: 0 0 30px rgba(0, 210, 255, 0.6);
        transition: transform 0.05s ease-out;
        will-change: transform;
      }

      /* å­—å¹•ã‚¨ãƒªã‚¢ */
      #transcription {
        position: absolute;
        bottom: 10%;
        width: 80%;
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px #000, 0 0 10px rgba(0, 0, 0, 0.8);
        pointer-events: none;
        max-height: 40vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
      }

      .message-row {
        margin: 5px 0;
        padding: 5px 15px;
        border-radius: 10px;
        animation: popIn 0.3s ease-in;
      }
      .user-message { color: #ffffff; }
      .ai-message { color: #ffeb3b; font-size: 1.1em; }
      .error-message { color: #ff5252; }

      @keyframes popIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body class="w-screen h-screen relative">

    <div id="homeScreen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 transition-opacity duration-500">
      <div class="text-center space-y-8 max-w-lg px-6">
        <div>
          <h1 class="text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
            OINORI
          </h1>
          <p class="text-gray-400">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°å¯¾è©±ã«ã‚ˆã‚‹é¢æ¥ç·´ç¿’</p>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
          <label class="block mb-2 text-sm font-medium text-gray-300">
            äº‹å‰ã«å±¥æ­´æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (ä»»æ„)
          </label>
          <input
            id="resumeInput"
            type="file"
            class="block w-full text-sm text-gray-400
              file:mr-4 file:py-2 file:px-4
              file:rounded-full file:border-0
              file:text-sm file:font-semibold
              file:bg-blue-600 file:text-white
              hover:file:bg-blue-700
              cursor-pointer bg-gray-700 rounded-lg border border-gray-600 focus:outline-none"
          />
          <p class="text-xs text-gray-500 mt-2">
            â€» PDF, Word, Textå½¢å¼ã«å¯¾å¿œã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨AIãŒå†…å®¹ã‚’å­¦ç¿’ã—ã¾ã™ã€‚
          </p>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg mt-4">
          <label class="block mb-2 text-sm font-medium text-gray-300">
            é¢æ¥ã®é›£æ˜“åº¦ï¼ˆé¢æ¥å®˜ã®ã‚¿ã‚¤ãƒ—ï¼‰
          </label>
          <select
            id="difficultySelect"
            class="block w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="easy">EASYï¼šè¦ªåˆ‡ã§å„ªã—ã„é¢æ¥å®˜</option>
            <option value="normal">NORMALï¼šä¸€èˆ¬çš„ãªé¢æ¥å®˜</option>
            <option value="hard" selected>HARDï¼šåœ§è¿«ãƒ»ãŠç¥ˆã‚Šãƒ¢ãƒ¼ãƒ‰</option>
          </select>
        </div>

        <button
          id="enterBtn"
          class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition hover:scale-105 text-xl mt-10"
        >
          é¢æ¥ä¼šå ´ã¸å…¥ã‚‹
        </button>
      </div>
    </div>

    <div id="interviewScreen" class="hidden absolute inset-0 flex justify-center items-center bg-[#1a1a1a]">
      
      <div class="absolute top-5 left-5 z-10 bg-black/50 p-4 rounded-lg backdrop-blur-sm border border-white/10 w-64">
        <h2 class="text-white text-sm font-bold mb-3 border-b border-gray-600 pb-2">ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
        <div class="flex gap-2">
          <button
            id="startBtn"
            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded text-sm transition"
          >
            ä¼šè©±é–‹å§‹
          </button>
          <button
            id="stopBtn"
            disabled
            class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded text-sm transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            çµ‚äº†
          </button>
        </div>
        <div id="statusText" class="text-xs text-gray-400 mt-2">å¾…æ©Ÿä¸­...</div>
      </div>
      <div id="sphere"></div>

      <div id="transcription"></div>
    </div>

    <div id="resultScreen" class="hidden absolute inset-0 flex flex-col justify-center items-center bg-gray-900 z-50 overflow-y-auto py-10">
      <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full border border-gray-700">
        <h2 class="text-3xl font-bold text-center text-white mb-6">é¢æ¥çµæœ</h2>
        
        <div class="flex justify-center mb-8">
          <div class="relative w-40 h-40 flex items-center justify-center rounded-full border-8 border-blue-500 shadow-[0_0_20px_rgba(59,130,246,0.5)]">
            <span id="scoreText" class="text-5xl font-bold text-white">--</span>
            <span class="absolute bottom-8 text-sm text-gray-400">ç‚¹</span>
          </div>
        </div>

        <div class="space-y-6 text-left">
          <div>
            <h3 class="text-green-400 font-bold text-lg mb-2">ğŸ‘ è‰¯ã‹ã£ãŸç‚¹</h3>
            <p id="goodPoints" class="text-gray-300 text-sm whitespace-pre-wrap leading-relaxed bg-gray-700/50 p-3 rounded"></p>
          </div>
          
          <div>
            <h3 class="text-red-400 font-bold text-lg mb-2">ğŸ¤” æ”¹å–„ç‚¹</h3>
            <p id="badPoints" class="text-gray-300 text-sm whitespace-pre-wrap leading-relaxed bg-gray-700/50 p-3 rounded"></p>
          </div>

          <div>
            <h3 class="text-blue-400 font-bold text-lg mb-2">ğŸ’¡ ç·è©•ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
            <p id="adviceText" class="text-gray-300 text-sm whitespace-pre-wrap leading-relaxed bg-gray-700/50 p-3 rounded"></p>
          </div>
        </div>

        <div class="mt-8 text-center">
          <button onclick="location.reload()" class="bg-white text-gray-900 hover:bg-gray-200 font-bold py-3 px-8 rounded-full shadow transition">
            ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
          </button>
        </div>
      </div>
    </div>

    <script>
      let socket;
      let audioContext;
      let processor;
      let input;
      let globalStream;
      let analyser;
      let animationId;
      
      // å±¥æ­´æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜ã™ã‚‹å¤‰æ•°
      let resumeData = null;

      // DOMè¦ç´ 
      const homeScreen = document.getElementById("homeScreen");
      const interviewScreen = document.getElementById("interviewScreen");
      const enterBtn = document.getElementById("enterBtn");
      const resumeInput = document.getElementById("resumeInput");
      const resultScreen = document.getElementById("resultScreen");

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const transcriptionDiv = document.getElementById("transcription");
      const sphere = document.getElementById("sphere");
      const statusText = document.getElementById("statusText");
      // --- 1. ãƒ›ãƒ¼ãƒ ç”»é¢ã®å‡¦ç† ---

      // å±¥æ­´æ›¸ãŒé¸æŠã•ã‚ŒãŸã‚‰ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã‚“ã§ãŠã
      resumeInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
          resumeData = {
            type: "resume",
            filename: file.name,
            content: event.target.result // Base64
          };
          console.log("å±¥æ­´æ›¸æº–å‚™OK:", file.name);
        };
        reader.readAsDataURL(file);
      });

      // ã€Œé¢æ¥ä¼šå ´ã¸å…¥ã‚‹ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®é·ç§»
      enterBtn.onclick = () => {
        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        homeScreen.classList.add("opacity-0");
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        setTimeout(() => {
          homeScreen.style.display = "none";
          interviewScreen.classList.remove("hidden");
          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã£ã½ãè¦‹ã›ã‚‹ï¼ˆä»Šå›ã¯å³è¡¨ç¤ºï¼‰
        }, 500);
      };

      startBtn.onclick = async () => {
        // 1. WebSocketæ¥ç¶šã‚’ä½œæˆ
        socket = new WebSocket("ws://" + window.location.host + "/ws/transcribe/");

        // 2. æ¥ç¶šæ™‚ã®å‡¦ç†
        socket.onopen = async () => {
          statusText.innerText = "æ¥ç¶šå®Œäº†";
          console.log("WebSocket Connected");
          
          const difficulty = document.getElementById("difficultySelect").value;
          const initData = {
            type: "config", // è¨­å®šé€ä¿¡ç”¨ã®ã‚¿ã‚¤ãƒ—
            difficulty: difficulty,
            resume: (typeof resumeData !== 'undefined') ? resumeData : null
          };
          socket.send(JSON.stringify(initData));
          // å±¥æ­´æ›¸ãŒã‚ã‚Œã°é€ä¿¡
          let msg = `é›£æ˜“åº¦: ${difficulty.toUpperCase()} ã§é–‹å§‹ã—ã¾ã™`;
          if (initData.resume) msg += ` (å±¥æ­´æ›¸ã‚ã‚Š)`;
          addMessage("system", msg);

          startRecording();
        };

        // 3. â˜…ã“ã“ã«ã€Œå…¨ã¦ã®å—ä¿¡å‡¦ç†ã€ã‚’ã¾ã¨ã‚ã¾ã™ï¼ˆå¤–ã«å‡ºã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ï¼‰
        socket.onmessage = (e) => {
          const data = JSON.parse(e.data);
          console.log("å—ä¿¡ãƒ‡ãƒ¼ã‚¿:", data); // ãƒ‡ãƒãƒƒã‚°ç”¨

          // (A) éŸ³å£°å†ç”Ÿ
          if (data.type === "audio") {
            const audio = new Audio("data:audio/mp3;base64," + data.audio);
            audio.play().catch((e) => console.error("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
            return;
          }

          // (B) ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã¸ã®é·ç§»
          if (data.type === "evaluation_result") {
            const result = data.data;

            // ç”»é¢ã®å€¤ã‚’æ›´æ–°
            document.getElementById("scoreText").innerText = result.score;
            document.getElementById("goodPoints").innerText = result.good_points;
            document.getElementById("badPoints").innerText = result.bad_points;
            document.getElementById("adviceText").innerText = result.advice;

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            interviewScreen.style.display = "none";
            resultScreen.classList.remove("hidden");
            
            // ã‚½ã‚±ãƒƒãƒˆã‚’åˆ‡æ–­
            socket.close();
            return;
          }

          // (C) é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º
          addMessage(data.type, data.message);
        };
        
        // 4. åˆ‡æ–­æ™‚ã®å‡¦ç†
        socket.onclose = () => {
            statusText.innerText = "åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ";
        }
      };
      
      // Stopãƒœã‚¿ãƒ³ã®å‡¦ç†ã¯ãã®ã¾ã¾å¤–ã«ã‚ã£ã¦OK
      stopBtn.onclick = () => {
        stopRecording();
        statusText.innerText = "AIãŒè©•ä¾¡ã‚’ä½œæˆä¸­...";
        
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: "finish" }));
        }
      };

      function addMessage(type, text) {
        const div = document.createElement("div");
        div.classList.add("message-row");
        div.innerText = text;

        if (type === "ai") div.classList.add("ai-message");
        else if (type === "error") div.classList.add("error-message");
        else if (type === "system") div.classList.add("text-gray-400", "text-sm"); // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨
        else div.classList.add("user-message");

        transcriptionDiv.appendChild(div);

        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        if (transcriptionDiv.childElementCount > 6) {
           transcriptionDiv.removeChild(transcriptionDiv.firstChild);
        }
      }

      async function startRecording() {
        startBtn.disabled = true;
        stopBtn.disabled = false;
        statusText.innerText = "éŒ²éŸ³ä¸­...";
        transcriptionDiv.innerHTML = ""; // ç”»é¢ã‚¯ãƒªã‚¢

        audioContext = new (window.AudioContext || window.webkitAudioContext)({
          sampleRate: 16000,
        });

        try {
          globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          input = audioContext.createMediaStreamSource(globalStream);

          // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ç”¨
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          input.connect(analyser);
          visualize();

          // éŒ²éŸ³ãƒ—ãƒ­ã‚»ãƒƒã‚µ
          processor = audioContext.createScriptProcessor(4096, 1, 1);
          input.connect(processor);

          // ãƒã‚¦ãƒªãƒ³ã‚°é˜²æ­¢
          const muteNode = audioContext.createGain();
          muteNode.gain.value = 0;
          processor.connect(muteNode);
          muteNode.connect(audioContext.destination);

          processor.onaudioprocess = (e) => {
            const inputData = e.inputBuffer.getChannelData(0);
            if (socket && socket.readyState === WebSocket.OPEN) {
              socket.send(inputData.buffer);
            }
          };
        } catch (e) {
          console.error(e);
          alert("ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™");
          statusText.innerText = "ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼";
          startBtn.disabled = false;
        }
      }

      function visualize() {
        if (!analyser) return;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
        const average = sum / dataArray.length;
        const scale = 1 + average * 0.02;

        sphere.style.transform = `scale(${scale})`;
        animationId = requestAnimationFrame(visualize);
      }

      function stopRecording() {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        
        if (globalStream) globalStream.getTracks().forEach((track) => track.stop());
        if (processor) processor.disconnect();
        if (analyser) analyser.disconnect();
        if (input) input.disconnect();
        if (audioContext) audioContext.close();
        if (animationId) cancelAnimationFrame(animationId);

        sphere.style.transform = "scale(1)";
      }
    </script>
  </body>
</html>